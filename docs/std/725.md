###### #std725

# Оптимизация использования оперативной памяти

!!! tip "Методическая рекомендация"

    Не проектируйте решение из предположения о неограниченной оперативной памяти.

###### 1.

Неэффективное использование памяти в многопользовательских системах быстро снижает стабильность работы.

Избегайте формирования больших структур данных в памяти.
Если объем данных потенциально не ограничен, обрабатывайте данные порциями
и сохраняйте промежуточные результаты в базу или файл.

###### 2.

При потенциально неограниченных выборках из ИБ получайте данные порциями фиксированного размера.

!!! failure "Неправильно"

    Результат запроса целиком загружается в память:

    ```bsl
    Запрос = Новый Запрос;
    Запрос.Текст =
        "ВЫБРАТЬ
        |   Номенклатура.Ссылка,
        |   Номенклатура.Наименование,
        |   Номенклатура.ВидНоменклатуры
        |ИЗ
        |   Справочник.Номенклатура КАК Номенклатура";

    // Выгрузка всего справочника в таблицу значений
    Номенклатура = Запрос.Выполнить().Выгрузить();
    Для Каждого ПозицияНоменклатуры Из Номенклатура Цикл
        // Обработка элемента справочника
    КонецЦикла;
    ```

!!! failure "Неправильно"

    Неверно полагаться, что `Выбрать()` всегда решает проблему объема:

    ```bsl
    Запрос = Новый Запрос;
    Запрос.Текст =
        "ВЫБРАТЬ
        |   Номенклатура.Ссылка,
        |   Номенклатура.Наименование,
        |   Номенклатура.ВидНоменклатуры
        |ИЗ
        |   Справочник.Номенклатура КАК Номенклатура";

    РезультатЗапроса = Запрос.Выполнить();
    ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
    Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
        // Обработка элемента выборки
    КонецЦикла;
    ```

!!! success "Правильно"

    Используйте искусственное ограничение порции, например `ПЕРВЫЕ 1000`:

    ```bsl
    Пока Истина Цикл

        Запрос = Новый Запрос;
        Запрос.Текст =
            "ВЫБРАТЬ ПЕРВЫЕ 1000
            |   Номенклатура.Ссылка,
            |   Номенклатура.Наименование,
            |   Номенклатура.ВидНоменклатуры
            |ИЗ
            |   Справочник.Номенклатура КАК Номенклатура
            |ГДЕ
            |   <условие выборки необработанных записей>";

        РезультатЗапроса = Запрос.Выполнить();
        Если РезультатЗапроса.Пустой() Тогда
            Прервать;
        КонецЕсли;

        ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
        Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
            // Обработка элемента выборки
        КонецЦикла;

    КонецЦикла;
    ```

!!! success "Правильно"

    Допустим поэлементный обход через `Выбрать` объекта метаданных:

    ```bsl
    Выборка = Справочники.Номенклатура.Выбрать(..., Отбор);
    Пока Выборка.Следующий() Цикл
        // Обработка элемента выборки
    КонецЦикла;
    ```

В этом случае платформа получает данные порциями фиксированного размера.

!!! tip "Примечание"

    В 32-битной версии платформы при нехватке памяти большие результаты
    могут временно выгружаться на диск, что дополнительно снижает производительность.

###### 3.

Не обрабатывайте большие XML/HTML/текстовые файлы объектами,
которые загружают файл целиком в память:

- `ТекстовыйДокумент`;
- `ДокументDOM`;
- `ДокументHTML`;
- целиковая загрузка больших `XDTO`-пакетов.

Исключение: когда нужен произвольный доступ к конкретным частям документа.

Для экономного расхода памяти используйте потоковые объекты:

- `ЧтениеXML`, `ЧтениеТекста`;
- `ЗаписьXML`, `ЗаписьТекста`.

Для XDTO читайте файл последовательно через `ЧтениеXML`,
а отдельные фрагменты десериализуйте фабрикой XDTO.

###### 4.

Избегайте утечек памяти из-за циклических ссылок.

!!! failure "Неправильно"

    Упрощенный пример циклической ссылки:

    ```bsl
    Данные = Новый Структура;
    Данные.Вставить("Ключ", Данные);
    ```

!!! success "Правильно"

    Разрывайте ссылку, когда объект больше не нужен:

    ```bsl
    Данные.Ключ = Неопределено;
    ```

Для выявления утечек используйте технологический журнал,
добавив в `logcfg.xml` элемент `<leaks>`.

См. также:

- [Документация платформы: Приложение 3. Описание и расположение служебных файлов (`logcfg.xml`)](https://its.1c.ru/db/v83doc/content/27/hdoc)
- [Поиск циклических ссылок](https://its.1c.ru/db/metod8dev/content/5859)

###### 5.

Чрезмерное применение общих модулей с повторным использованием возвращаемых значений
тоже приводит к излишнему потреблению памяти.

###### См. также

- [#std724: Использование модулей с повторным использованием возвращаемых значений](724.md)

###### Источник

https://its.1c.ru/db/v8std#content:725
